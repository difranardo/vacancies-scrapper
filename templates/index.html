<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vacancies Scraper ・ Randstad</title>
  <!-- ========================  BASE STYLES  ======================== -->
  <style>
    :root {
      /* Paleta corporativa Randstad */
      --brand-1:#0066B3;  /* azul principal */
      --brand-1-dark:#003B73;
      --brand-2:#00A0E1; /* acento */
      --grey-0:#FFFFFF;
      --grey-1:#F7F9FC;
      --grey-3:#E1E5EB;
      --grey-7:#4A5568;
      --radius:12px;
    }

    /* Reset mínimo */
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--grey-1);color:var(--grey-7);min-height:100vh;display:flex;flex-direction:column;}

    /* ==========================  LAYOUT  ========================== */
    header{
      background:var(--brand-1);color:var(--grey-0);padding:1rem 1.75rem;display:flex;align-items:center;gap:.75rem;
    }
    .logo-icon{width:30px;height:30px;fill:currentColor;flex:none;}
    .logo-text{font-size:1.45rem;font-weight:600;letter-spacing:.4px;text-transform:capitalize;}

    main{
      width:min(960px,92%);margin:2.25rem auto;padding:2.25rem 2.5rem;background:var(--grey-0);border-radius:var(--radius);box-shadow:0 6px 20px rgba(0,0,0,.06);flex:1;
    }
    h1{font-size:1.75rem;font-weight:600;color:var(--brand-1-dark);margin-bottom:1.75rem;text-align:center;}

    /* ========================  FORM  ========================= */
    form{
      display:grid;gap:1.15rem 1.5rem;align-items:end;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    }
    label{display:block;font-size:.85rem;font-weight:600;margin-bottom:.35rem;}
    input,select,button{width:100%;padding:.6rem .8rem;border:1px solid var(--grey-3);border-radius:6px;font-size:.95rem;}
    input:focus,select:focus{outline:none;border-color:var(--brand-1);box-shadow:0 0 0 2px rgba(0,102,179,.15);}
    button[type="submit"]{
      background:var(--brand-1);color:var(--grey-0);border:none;font-weight:600;cursor:pointer;transition:background .25s;}
    button[type="submit"]:hover:not([disabled]){background:var(--brand-1-dark);} 
    button[disabled]{opacity:.55;cursor:not-allowed;}

    /* ==================  LOADING BANNER  =================== */
    #loading{
      display:none;margin-top:1.5rem;padding:.85rem 1.1rem;border-radius:8px;font-weight:600;background:var(--brand-2);color:var(--grey-0);align-items:center;gap:.8rem;
    }
    .spinner{
      width:20px;height:20px;border:3px solid rgba(255,255,255,.35);border-top-color:var(--grey-0);border-radius:50%;animation:spin .8s linear infinite;
    }
    @keyframes spin{to{transform:rotate(360deg);}}
    #btnCancel{
      margin-left:auto;background:transparent;border:2px solid var(--grey-0);color:var(--grey-0);padding:.38rem .9rem;border-radius:6px;font-size:.85rem;cursor:pointer;transition:background .25s;}
    #btnCancel:hover{background:rgba(255,255,255,.12);}

    /* ====================  DOWNLOAD LINK  ==================== */
    #downloadWrap{display:none;margin-top:2rem;text-align:center;}
    .download-excel{display:inline-block;padding:.68rem 1.6rem;border-radius:6px;background:var(--brand-1);color:var(--grey-0);font-weight:600;text-decoration:none;transition:background .25s;}
    .download-excel:hover{background:var(--brand-1-dark);}

    /* ====================  RESPONSIVE  ===================== */
    @media(max-width:520px){
      main{padding:1.75rem 1.5rem;}
      h1{font-size:1.45rem;}
      form{grid-template-columns:1fr;}
      #btnCancel{padding:.3rem .8rem;}
    }
  </style>
</head>
<body>
  <!-- ===============================  HEADER  =============================== -->
  <header>
    <svg class="logo-icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.8 2h6.4c.66 0 1.2.54 1.2 1.2v5.6c0 .66-.54 1.2-1.2 1.2h-2.4V22H10V10H7.6C6.94 10 6.4 9.46 6.4 8.8V3.2C6.4 2.54 6.94 2 7.6 2h1.2z"/></svg>
    <span class="logo-text">vacancies scraper</span>
  </header>

  <!-- ===============================  MAIN  ================================ -->
  <main>
    <h1>Buscar vacantes</h1>

    <!-- FORM -->
    <form id="scrapeForm" autocomplete="off">
      <div>
        <label for="keyword">Palabra clave *</label>
        <input id="keyword" name="keyword" placeholder="QA, Python…" required>
      </div>
      <div>
        <label for="location">Ubicación *</label>
        <input id="location" name="location" placeholder="Buenos Aires, remoto…" required>
      </div>
      <div>
        <label for="pages">Páginas a scrapear</label>
        <input id="pages" name="pages" type="number" min="1" placeholder="1 (todas)" value="1">
      </div>
      <div>
        <label for="portal">Portal</label>
        <select id="portal" name="portal">
          <option value="bumeran">Bumeran</option>
          <option value="zonajobs">ZonaJobs</option>
          <option value="computrabajo">Computrabajo</option>
        </select>
      </div>
      <div>
        <button type="submit">Scrapear</button>
      </div>
    </form>

    <!-- LOADING -->
    <div id="loading">
      <div class="spinner" role="status" aria-label="Procesando"></div>
      Procesando…
      <button id="btnCancel" type="button">Cancelar</button>
    </div>

    <!-- DOWNLOAD -->
    <div id="downloadWrap">
      <a id="btnExcel" class="download-excel" href="#" download>Descargar Excel</a>
    </div>
  </main>

  <!-- ===========================  FRONT‑END JS  =========================== -->
  <script>
  // Sin dependencias externas – mantiene toda la lógica original
  const form = document.getElementById("scrapeForm");
  const loading = document.getElementById("loading");
  const cancelBtn = document.getElementById("btnCancel");
  const downloadWrap = document.getElementById("downloadWrap");
  const btnExcel = document.getElementById("btnExcel");
  let currentJob = null;
  const POLL_MS = 4000;

  const show = el => el.style.display = el.dataset.flex ? el.dataset.flex : "flex";
  const hide = el => el.style.display = "none";
  const toggleForm = enabled => [...form.elements].forEach(e => e.disabled = !enabled);

  cancelBtn.addEventListener("click", async () => {
    if(!currentJob){ resetUI(); return; }
    await fetch("/stop-scrape",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({ job_id: currentJob })
    });
    resetUI();
  });

  form.addEventListener("submit", async e => {
    e.preventDefault();
    const fd = new FormData(form);
    const payload = {
      sitio: fd.get("portal"),
      cargo: fd.get("keyword").trim(),
      ubicacion: fd.get("location").trim(),
      pages: parseInt(fd.get("pages"),10) || 1,
      formato: "excel"
    };
    toggleForm(false); show(loading);
    const res = await fetch("/scrape",{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify(payload)
    });
    if(!res.ok){ alert(await res.text()); resetUI(); return; }
    currentJob = (await res.json()).job_id;
    poll();
  });

  async function poll(){
    if(!currentJob) return;
    const head = await fetch(`/download/${currentJob}`,{ method:"HEAD" });
    if(head.status === 200){
      btnExcel.href = `/download/${currentJob}?fmt=excel`;
      downloadWrap.style.display = "block";
      btnExcel.click();
      resetUI(false); // deja el link visible
    } else if(head.status === 404){
      setTimeout(poll, POLL_MS);
    } else if(head.status === 204){
      alert("No se encontraron resultados.");
      resetUI();
    } else {
      alert(`Error ${head.status}`);
      resetUI();
    }
  }

  function resetUI(hideDownload=true){
    hide(loading); toggleForm(true); currentJob = null;
    if(hideDownload){ downloadWrap.style.display = "none"; btnExcel.href = "#"; }
  }
  </script>
</body>
</html>
